<!DOCTYPE html>
<html>
  <head>
    <title>SignalFlow EEG Dataset Portal V2</title>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="public/styles.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container">
      <header>
        <h1>SignalFlow EEG Dataset Portal</h1>
      </header>
      <div class="tabs">
        <button class="tablinks" onclick="openTab(event, 'Upload')">
          Upload EEG Data
        </button>
        <button class="tablinks" onclick="openTab(event, 'Manage')">
          Manage EEG Datasets
        </button>
        <button class="tablinks" onclick="openTab(event, 'DatasetManagement')">
          Edit EEG Datasets
        </button>
      </div>
      <div id="Upload" class="tabcontent">
        <form id="uploadForm">
          <div class="form-group">
            <label for="datasetOption">Choose Dataset Action:</label>
            <select
              id="datasetOption"
              name="datasetOption"
              onchange="datasetOptionChanged(this)"
            >
              <option value="new" selected>Create New Dataset</option>
              <option value="merge">Merge with an Existing Dataset</option>
            </select>
          </div>
          <div class="form-group" id="datasetNameGroup">
            <label for="datasetName">New Dataset Name:</label>
            <input
              type="text"
              id="datasetName"
              name="datasetName"
              placeholder="Enter new dataset name"
            />
            <input type="hidden" id="datasetId" name="datasetId" value="" />
          </div>
          <div class="form-group" id="datasetMergeGroup" style="display: none">
            <label for="existingDatasets">
              Select an Existing Dataset to Merge:
            </label>
            <select id="existingDatasets" name="existingDatasets"></select>
          </div>

          <div class="form-group" id="eegFormatsGroup">
            <label for="eegFormats"> Select EEG Format: </label>
            <select id="eegFormats" name="eegFormats"></select>
          </div>

          <script>
            const API_URL = "http://localhost:8001/api"; // Replace with your actual API URL

            // Define a function to streamline fetch requests and parse JSON
            function fetchAPI(endpoint, options = {}) {
              const url = `${API_URL}/${endpoint}`;
              return fetch(url, options)
                .then((response) => {
                  if (!response.ok) {
                    throw new Error("Network response was not ok");
                  }
                  return response.json();
                })
                .catch((error) => console.error("API Error:", error));
            }

            window.addEventListener("load", function () {
              fetchAPI("list-eeg-formats")
                .then((data) => {
                  const select = document.getElementById("eegFormats");
                  data.forEach((item) => {
                    const option = document.createElement("option");
                    option.value = item.id;
                    option.text =
                      item.name.toUpperCase() + " (" + item.description + ")";
                    select.appendChild(option);
                  });
                })
                .catch((error) => console.error("Error:", error));
            });
          </script>

          <div class="form-group" id="eegParadigmsGroup">
            <label for="eegParadigms"> Select EEG Paradigm: </label>
            <select id="eegParadigms" name="eegParadigms"></select>
          </div>
          <script>
            window.onload = function () {
              fetchAPI("list-eeg-paradigms")
                .then((data) => {
                  const select = document.getElementById("eegParadigms");
                  data.forEach((item) => {
                    const option = document.createElement("option");
                    option.value = item.id;
                    option.text =
                      item.name.toUpperCase() + " (" + item.description + ")";
                    select.appendChild(option);
                  });
                })
                .catch((error) => console.error("Error:", error));
            };
          </script>

          <div class="form-group">
            <label for="email">Your Email Address:</label>
            <input
              type="email"
              id="email"
              name="email"
              placeholder="Enter your email address"
              value="user@example.com"
            />
          </div>
          <div class="form-group">
            <label>Dataset Files Upload:</label>
            <div id="app"></div>
          </div>
          <div
            style="display: flex; justify-content: flex-end; margin-top: 10px"
          >
            <button
              type="submit"
              class="btn"
              style="font-size: 0.8rem; margin-right: 10px"
            >
              Start Upload
            </button>
            <button
              type="reset"
              class="btn"
              style="background-color: red; font-size: 0.8rem"
            >
              Reset Form
            </button>
          </div>
        </form>
      </div>

      <div id="Manage" class="tabcontent">
        <h2>Database Management</h2>
        <div
          class="dataset-actions"
          style="display: flex; justify-content: flex-end; margin-top: 10px"
        >
          <button
            class="btn"
            style="font-size: 0.8rem; margin-right: 10px"
            onclick="dropTables()"
          >
            Drop All Tables
          </button>
        </div>
        <h2>Portal Tasks and Tests</h2>
        <div
          class="dataset-actions"
          style="display: flex; justify-content: flex-end; margin-top: 10px"
        >
          <button
            class="btn"
            style="font-size: 0.8rem; margin-right: 10px"
            onclick="process_uploads()"
          >
            Process Uploads
          </button>
        </div>
        <div
          class="dataset-actions"
          style="display: flex; justify-content: flex-end; margin-top: 10px"
        >
          <button
            class="btn"
            style="font-size: 0.8rem; margin-right: 10px"
            onclick="toggleConfig()"
          >
            View Config
          </button>
          <pre
            id="show-config"
            style="margin-left: 10px; font-size: 0.8rem; display: none"
          ></pre>
        </div>

        <script>
          let configVisible = false;

          function toggleConfig() {
            const configDiv = document.getElementById("show-config");
            if (configVisible) {
              configDiv.style.display = "none";
            } else {
              fetchAPI("request-config")
                .then((data) => {
                  configDiv.textContent = JSON.stringify(data, null, 2);
                  configDiv.style.display = "block";
                })
                .catch((error) => {
                  console.error("Error fetching config:", error);
                });
            }
            configVisible = !configVisible;
          }
        </script>
        <h2>Dataset Organization and Management</h2>
        <div
          class="dataset-actions"
          style="display: flex; justify-content: flex-end; margin-top: 10px"
        >
          <button
            class="btn"
            style="font-size: 0.8rem; margin-right: 10px"
            onclick="createDataset()"
          >
            Create Dataset
          </button>
          <button
            class="btn"
            style="font-size: 0.8rem; margin-right: 10px"
            onclick="deleteDataset()"
          >
            Delete Dataset
          </button>
          <button
            class="btn"
            style="font-size: 0.8rem"
            onclick="downloadDataset()"
          >
            Download Dataset
          </button>
        </div>
        <div class="dataset-table-container">
          <table class="dataset-table">
            <thead>
              <tr>
                <th>Dataset Name</th>
                <th>File Count</th>
                <th>Total Size</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="dataset-table-body">
              <!-- Dataset records will be dynamically inserted here -->
            </tbody>
          </table>
        </div>
      </div>

      <div id="DatasetManagement" class="tabcontent">
        <h2>Manage Dataset Catalog</h2>
        <div class="dataset-catalog-table-container" style="width: 100%">
          <table
            class="dataset-catalog-table table table-striped"
            style="width: 100%"
          >
            <thead>
              <tr style="text-align: left">
                <th>Name</th>
                <th>ID</th>
                <th>Desc</th>
                <th>Format</th>
                <th>Paradigm</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="dataset-catalog-table-body">
              <!-- Dataset Catalog records will be dynamically inserted here -->
              <script>
                window.addEventListener("load", function () {
                  fetchAPI("get-dataset-info")
                    .then((data) => {
                      const tableBody = document.getElementById(
                        "dataset-catalog-table-body"
                      );
                      data.forEach((item) => {
                        const row = document.createElement("tr");
                        row.innerHTML = `
                        <td style="text-align: left;">${item.dataset_name}</td>
                        <td>${item.dataset_id}</td>
                        <td>${item.description}</td>
                        <td>${item.eeg_format.name}</td>
                        <td>${item.eeg_paradigm.name}</td>
                        <td>
                          <button class="btn btn-info" style="font-size: 1rem;" onclick="updateDatasetCatalog('${item.dataset_id}')">Update</button>
                        </td>
                      `;
                        tableBody.appendChild(row);
                      });
                    })
                    .catch((error) => console.error("Error:", error));
                });
              </script>
            </tbody>
          </table>
        </div>
        <div class="dataset-catalog-form-container">
          <button class="btn btn-success" onclick="toggleDatasetForm()">
            Add/Edit Dataset
          </button>
          <div id="dataset-form" class="card mt-3" style="display: none">
            <div class="card-body">
              <form onsubmit="saveDataset(event)">
                <div class="form-group">
                  <label for="dataset-name">Dataset Name:</label>
                  <input
                    type="text"
                    id="dataset-name"
                    name="dataset-name"
                    class="form-control"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="dataset-id">Dataset ID:</label>
                  <input
                    type="text"
                    id="dataset-id"
                    name="dataset-id"
                    class="form-control"
                    readonly
                  />
                </div>
                <div class="form-group">
                  <label for="dataset-description">Description:</label>
                  <textarea
                    id="dataset-description"
                    name="dataset-description"
                    class="form-control"
                  ></textarea>
                </div>
                <div class="form-group">
                  <label for="eeg-format">EEG Format:</label>
                  <select
                    id="eeg-format"
                    name="eeg-format"
                    class="form-control"
                  >
                    <!-- Options for EEG formats will be dynamically inserted here -->
                  </select>
                </div>
                <div class="form-group">
                  <label for="eeg-paradigm">EEG Paradigm:</label>
                  <select
                    id="eeg-paradigm"
                    name="eeg-paradigm"
                    class="form-control"
                  >
                    <!-- Options for EEG paradigms will be dynamically inserted here -->
                  </select>
                </div>
                <div class="form-group">
                  <button type="submit" class="btn btn-primary">Save</button>
                  <button
                    type="button"
                    class="btn btn-secondary"
                    onclick="resetDatasetForm()"
                  >
                    Reset
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
      <script>
        function generateUUID() {
          const uuid = crypto.randomUUID();
          document.getElementById("dataset-id").value = uuid;
          return uuid;
        }

        function toggleDatasetForm() {
          var form = document.getElementById("dataset-form");
          form.style.display = form.style.display === "none" ? "block" : "none";
          document.getElementById("dataset-id").value = generateUUID();
        }

        function saveDataset(event) {
          event.preventDefault();
          const formData = new FormData(event.target);
          const datasetData = Object.fromEntries(formData.entries());

          fetchAPI("save-dataset", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(datasetData),
          })
            .then((data) => {
              console.log("Dataset saved:", data);
              resetDatasetForm();
              // Refresh the dataset catalog table
              fetchDatasetCatalog();
            })
            .catch((error) => {
              console.error("Error saving dataset:", error);
            });
        }

        function resetDatasetForm() {
          document.getElementById("dataset-form").reset();
          console.log("Form reset");
        }

        function fetchDatasetCatalog() {
          fetchAPI("get-dataset-info")
            .then((data) => {
              const tableBody = document.getElementById(
                "dataset-catalog-table-body"
              );
              tableBody.innerHTML = "";
              data.forEach((item) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                  <td style="text-align: left;">${item.dataset_name}</td>
                  <td>${item.dataset_id}</td>
                  <td>${item.description}</td>
                  <td>${item.eeg_format.name}</td>
                  <td>${item.eeg_paradigm.name}</td>
                  <td>
                    <button class="btn btn-info" style="font-size: 1rem;" onclick="updateDatasetCatalog('${item.dataset_id}')">Update</button>
                  </td>
                `;
                tableBody.appendChild(row);
              });
            })
            .catch((error) => console.error("Error:", error));
        }

        function updateDatasetCatalog(datasetId) {
          // Implement the logic to update the dataset catalog entry
          console.log("Update dataset catalog with ID:", datasetId);
        }
      </script>

      <script>
        function openTab(evt, tabName) {
          var i, tabcontent, tablinks;
          tabcontent = document.getElementsByClassName("tabcontent");
          for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
          }
          tablinks = document.getElementsByClassName("tablinks");
          for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(
              " active",
              ""
            );
          }
          document.getElementById(tabName).style.display = "block";
          evt.currentTarget.className += " active";
        }

        function datasetOptionChanged(selectObj) {
          var value = selectObj.value;
          if (value == "new") {
            document.getElementById("datasetNameGroup").style.display = "block";
            document.getElementById("datasetMergeGroup").style.display = "none";
          } else if (value == "merge") {
            document.getElementById("datasetNameGroup").style.display = "none";
            document.getElementById("datasetMergeGroup").style.display =
              "block";
          }
        }

        function dropTables() {
          if (confirm("Are you sure you want to drop all tables?")) {
            fetchAPI("drop-tables", {
              method: "GET",
            })
              .then((data) => {
                alert(data.message);
              })
              .catch((error) => {
                console.error("Error dropping tables:", error);
              });
          }
        }

        function process_uploads() {
          fetchAPI("process-uploads", {
            method: "GET",
          })
            .then((data) => {
              alert(data.message);
            })
            .catch((error) => {
              console.error("Error processing uploads:", error);
            });
        }

        document.addEventListener("DOMContentLoaded", function () {
          document.getElementById("datasetName").value =
            "Dataset_" + Date.now();
          // Automatically open the Upload tab on page load
          document.getElementsByClassName("tablinks")[0].click();
        });
      </script>
      <script src="src/index.js"></script>
    </div>
  </body>
</html>
